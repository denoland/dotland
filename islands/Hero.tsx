/** @jsx h */
import { h } from "preact";
import { useEffect, useRef, useState } from "preact/hooks";
import { tw } from "@twind";

type TerminalEvent = [number, string, string];

export default function Hero() {
  const refIdRef = useRef(0);
  const loop = (timestamp: number) => {
    const pulled = timeline.filter((i) => {
      return i[0] * 1000 <= timestamp && i[0] * 1000 > passed;
    });

    for (const item of pulled) {
      const [time, type, str] = item;
      passed = time * 1000;
      if (type === "i") {
        setTyped((prev) => prev + 1);
      }
      print(str);
    }
    refIdRef.current = requestAnimationFrame(loop);
  };
  useEffect(() => {
    loop(0);
    return () => cancelAnimationFrame(refIdRef.current);
  }, []);

  const userinput = `<span class="${tw`text-gray-400`}">$ </span>`;
  const events: TerminalEvent[] = [
    [0.1, "o", userinput],
    [0.5, "i", "deno run https://deno.land/std/examples/welcome.ts\r"],
    [0.1, "o", "Welcome to Deno!\r\r"],
    [0.1, "o", userinput],
    [0.5, "i", "cat add.js\r"],
    [0.1, "o", "function sum(a, b) {\r  return a // TODO\r}\r\r"],
    [0.1, "o", userinput],
    [0.5, "i", "deno lint add.js\r"],
    [
      0.5,
      "o",
      `<span class="${tw`text-red-500`}">no-unused-vars</span> \`b\` is never used
function sum(a, b) {
                <span class="${tw`text-red-500`}">^</span>
at error.js:1:16
Checked 1 file

`,
    ],
    [0.1, "o", userinput],
  ];

  let time = 0;
  const typingSpeed = 0.08;
  const timeline: TerminalEvent[] = events.flatMap((item) => {
    time += item[0];
    if (item[1] == "i") {
      const tt = time;
      time += item[2].length * typingSpeed;
      return item[2].split("").map((c, i): TerminalEvent => {
        return [tt + i * typingSpeed, "i", c];
      });
    }

    return [[time, item[1], item[2]]];
  });

  let passed = 0;
  const [text, setText] = useState("");
  const wrapperElement = useRef<HTMLDivElement>(null);

  function print(str: string) {
    setText((prev) =>
      prev + str.replace(
        /\r/g,
        "<br>",
      )
    );
    if (wrapperElement.current !== null) {
      wrapperElement.current.scrollTop = wrapperElement.current.scrollHeight;
    }
  }
  function println(str: string) {
    print(str + "<br />");
  }

  const [typed, setTyped] = useState(0);

  const offsetRight = typed % 2 === 0 ? { x: 0, y: -5 } : { x: 0, y: 0 };
  const offsetLeft = typed % 2 === 1 ? { x: 0, y: -5 } : { x: 0, y: 0 };

  const path =
    `M601 336.5C580.6 331.3 557.833 361 549 376.5C539.289 374.784 523.578 381.98 511 399.5C498.447 416.986 500.333 433.167 505 441C499.667 448.333 ${
      492.2 + offsetRight.x
    } ${464.6 + offsetRight.y} ${507 + offsetRight.x} ${471 + offsetRight.y}C${
      521.8 + offsetRight.x
    } ${477.4 + offsetRight.y} 531 459 531 459L541 463C541 463 ${
      525.5 + offsetLeft.x
    } ${482.5 + offsetLeft.y} ${543.5 + offsetLeft.x} ${489 + offsetLeft.y}C${
      566.2 + offsetLeft.x
    } ${
      497.197 + offsetLeft.y
    } 583 467.5 583 467.5C600.094 467.362 622 430 626 415.5C637 414 647.5 394 649.5 380.5C651.1 369.7 642.5 367.667 638 368C635.667 361.167 633.2 349.3 622 340.5C628.913 324.081 624.833 310.307 619.393 301.643C617.202 298.153 612.439 299.853 611.723 303.911C610.093 313.151 606.817 325.697 601 336.5Z`;

  return (
    <svg
      width="715"
      height="541"
      style="width: 100%"
      viewBox="0 0 715 541"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <rect width="715" height="541" fill="white" />
      <path
        d="M399.989 528.504L400.353 525.526L399.989 528.504ZM390.759 502.474C391.849 501.226 391.721 499.331 390.474 498.241C389.226 497.151 387.331 497.279 386.241 498.526L390.759 502.474ZM466.57 491.555C460.457 490.371 455.737 493.089 451.741 496.814C449.759 498.662 447.845 500.856 445.943 503.107C444.007 505.399 442.085 507.747 439.957 510.105C435.728 514.79 430.926 519.227 424.691 522.21C418.5 525.172 410.704 526.791 400.353 525.526L399.625 531.482C411.028 532.875 419.985 531.113 427.28 527.622C434.532 524.153 439.951 519.066 444.41 514.126C446.627 511.671 448.666 509.181 450.526 506.979C452.42 504.738 454.135 502.785 455.833 501.202C459.198 498.066 462.041 496.789 465.43 497.445L466.57 491.555ZM400.353 525.526C392.722 524.594 389.022 520.526 387.752 516.094C386.412 511.418 387.675 506.005 390.759 502.474L386.241 498.526C381.824 503.582 380.08 511.102 381.984 517.747C383.958 524.636 389.752 530.276 399.625 531.482L400.353 525.526Z"
        fill="#C7EDF9"
      />
      <path
        d="M442.5 420C362.5 420 377.21 503.119 184.5 492.5C-60.5 479 -26.5 148 213 126C376.198 111.009 417 -39.8334 604.5 83.5C717 157.5 727.395 329.104 662 408C584.5 501.5 527.848 420 442.5 420Z"
        fill="#D9F4A3"
      />
      <path
        d="M220.402 74.0975C223.945 69.1874 231.794 67.5051 237.931 70.3399L611.8 244.208L612.424 251.95C612.502 252.919 612.205 253.913 611.575 254.786L430.005 506.376C426.462 511.286 418.614 512.968 412.476 510.133L40.8125 338.469C39.6949 337.953 38.8824 337.087 38.5305 336.036L36.2588 329.254L220.402 74.0975Z"
        fill="#303030"
      />
      <path
        d="M214.502 76.1138L605.682 256.792L428.032 502.951C424.8 507.429 418.116 509.182 413.102 506.866L40.0784 334.574C35.0645 332.258 33.62 326.75 36.852 322.272L214.502 76.1138Z"
        fill="#303030"
      />
      <path
        d="M221.826 70.1571C224.25 66.7983 229.264 65.4835 233.024 67.2204L606.048 239.513C609.808 241.249 610.892 245.38 608.468 248.739L598.261 262.882L211.62 84.3L221.826 70.1571Z"
        fill="#D9D9D9"
        stroke="#303030"
        stroke-width="5"
      />
      <ellipse
        rx="3.67236"
        ry="3.28917"
        transform="matrix(0.907841 0.419314 -0.585206 0.810885 233.096 81.146)"
        fill="black"
      />
      <ellipse
        rx="3.67236"
        ry="3.28917"
        transform="matrix(0.907841 0.419314 -0.585206 0.810885 249.766 88.8454)"
        fill="black"
      />
      <ellipse
        rx="3.67236"
        ry="3.28917"
        transform="matrix(0.907841 0.419314 -0.585206 0.810885 233.096 81.146)"
        fill="black"
      />
      <ellipse
        rx="3.67236"
        ry="3.28917"
        transform="matrix(0.907841 0.419314 -0.585206 0.810885 249.766 88.8454)"
        fill="black"
      />
      <path
        d="M71 407C72.9546 405.978 76.6684 403.548 75.8865 402C80.1867 403.677 81.5875 406.032 81.7504 407C83.5935 405.899 89.7676 403.002 90.5462 402C94.7486 403.283 96.1785 405.955 93.9667 407"
        stroke="#B6D773"
        stroke-width="5"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <rect
        x="387.437"
        y="491.005"
        width="9"
        height="10.8235"
        rx="4.5"
        transform="rotate(35.2165 387.437 491.005)"
        fill="#303030"
      />
      <path
        d="M400 528.5L400.443 525.533L400 528.5ZM387.941 503.244C388.904 501.895 388.592 500.022 387.244 499.059C385.895 498.096 384.022 498.408 383.059 499.756L387.941 503.244ZM462.691 488.581C459.672 487.866 456.916 488.187 454.411 489.339C451.985 490.455 449.95 492.277 448.159 494.318C446.367 496.361 444.677 498.79 443.012 501.272C441.314 503.803 439.637 506.392 437.757 508.991C434.014 514.165 429.716 519 423.917 522.202C418.187 525.366 410.738 527.071 400.443 525.533L399.557 531.467C411.012 533.179 419.813 531.322 426.817 527.454C433.753 523.625 438.674 517.96 442.618 512.509C444.581 509.795 446.366 507.041 447.994 504.615C449.655 502.14 451.157 499.999 452.669 498.276C454.183 496.551 455.565 495.412 456.919 494.79C458.193 494.204 459.578 494.009 461.309 494.419L462.691 488.581ZM400.443 525.533C392.423 524.334 387.943 520.668 386.096 516.693C384.241 512.701 384.725 507.747 387.941 503.244L383.059 499.756C378.775 505.753 377.759 512.991 380.654 519.221C383.557 525.467 390.077 530.051 399.557 531.467L400.443 525.533Z"
        fill="#FE90AD"
      />
      <path
        d="M519.231 103.73C525.398 102.063 533.8 101.3 547 108.5C564.677 118.142 567.231 147.23 564.731 159.73C574.939 165.735 583.261 182.877 570.731 191.23C564.731 195.23 552.898 193.73 551.231 193.73C549.564 195.897 545.731 197.83 537.731 200.23C541.231 209.23 534.231 221.23 516.231 217.73C501.831 214.93 498.564 202.23 498.731 196.23C498.064 195.397 491.431 191.23 470.231 181.23C443.731 168.73 442.731 140.73 446.231 130.73C442.351 129.954 433.353 135.2 430.918 149.037C430.355 152.233 425.652 153.443 424.571 150.383C412.359 115.795 446.691 103.73 463.731 103.73C477.731 89.7301 506.564 97.8968 519.231 103.73Z"
        fill="#FE90AD"
      />
      <path
        d="M547 108.5L545.563 111.134L547 108.5ZM519.231 103.73L517.976 106.455L518.964 106.91L520.014 106.626L519.231 103.73ZM463.731 103.73V106.73H464.974L465.852 105.851L463.731 103.73ZM424.571 150.383L421.742 151.382H421.742L424.571 150.383ZM430.918 149.037L427.963 148.517L430.918 149.037ZM446.231 130.73L449.063 131.721L450.202 128.465L446.819 127.788L446.231 130.73ZM470.231 181.23L471.511 178.517L470.231 181.23ZM498.731 196.23L501.73 196.313L501.76 195.214L501.074 194.356L498.731 196.23ZM516.231 217.73L515.658 220.675L516.231 217.73ZM537.731 200.23L536.869 197.357L533.758 198.29L534.935 201.317L537.731 200.23ZM551.231 193.73V190.73H549.754L548.853 191.901L551.231 193.73ZM570.731 191.23L572.395 193.726H572.395L570.731 191.23ZM564.731 159.73L561.789 159.142C561.539 160.394 562.109 161.668 563.21 162.316L564.731 159.73ZM548.436 105.866C541.559 102.115 535.785 100.36 530.808 99.8083C525.813 99.255 521.781 99.9332 518.448 100.834L520.014 106.626C522.847 105.86 526.1 105.323 530.148 105.772C534.214 106.222 539.241 107.685 545.563 111.134L548.436 105.866ZM520.486 101.005C513.921 97.9818 503.218 94.3668 492.27 93.3066C481.43 92.2568 469.57 93.6483 461.61 101.609L465.852 105.851C471.892 99.812 481.449 98.2867 491.692 99.2787C501.827 100.26 511.874 103.645 517.976 106.455L520.486 101.005ZM463.731 100.73C454.701 100.73 441.146 103.882 431.309 111.742C426.337 115.715 422.239 120.955 420.264 127.653C418.287 134.361 418.519 142.254 421.742 151.382L427.4 149.384C424.517 141.218 424.462 134.633 426.019 129.35C427.579 124.058 430.84 119.797 435.054 116.43C443.59 109.61 455.721 106.73 463.731 106.73V100.73ZM433.872 149.557C434.99 143.206 437.573 139.025 440.12 136.558C441.402 135.316 442.659 134.522 443.705 134.084C444.804 133.623 445.46 133.635 445.643 133.672L446.819 127.788C445.062 127.437 443.139 127.814 441.383 128.551C439.574 129.31 437.702 130.547 435.945 132.249C432.414 135.67 429.281 141.03 427.963 148.517L433.872 149.557ZM443.399 129.739C441.41 135.422 440.823 145.594 444.122 155.953C447.464 166.446 454.845 177.29 468.951 183.943L471.511 178.517C459.117 172.67 452.748 163.265 449.839 154.132C446.888 144.866 447.552 136.038 449.063 131.721L443.399 129.739ZM468.951 183.943C479.521 188.929 486.422 192.443 490.744 194.801C492.908 195.982 494.4 196.858 495.371 197.474C495.858 197.784 496.188 198.01 496.394 198.163C496.673 198.371 496.569 198.33 496.388 198.104L501.074 194.356C500.726 193.922 500.269 193.568 499.975 193.35C499.608 193.076 499.144 192.763 498.585 192.408C497.462 191.696 495.846 190.75 493.618 189.534C489.156 187.1 482.141 183.531 471.511 178.517L468.951 183.943ZM495.732 196.147C495.635 199.641 496.518 204.902 499.454 209.737C502.452 214.674 507.562 219.101 515.658 220.675L516.804 214.785C510.5 213.56 506.777 210.236 504.583 206.623C502.327 202.908 501.66 198.819 501.73 196.313L495.732 196.147ZM515.658 220.675C525.356 222.561 532.745 220.365 537.201 215.752C541.611 211.188 542.684 204.688 540.527 199.143L534.935 201.317C536.278 204.772 535.601 208.773 532.886 211.583C530.217 214.345 525.105 216.4 516.804 214.785L515.658 220.675ZM538.593 203.104C542.654 201.885 545.79 200.748 548.168 199.59C550.528 198.442 552.372 197.168 553.609 195.559L548.853 191.901C548.424 192.459 547.517 193.235 545.543 194.195C543.589 195.146 540.807 196.175 536.869 197.357L538.593 203.104ZM551.231 196.73C551.23 196.73 551.235 196.73 551.248 196.73C551.261 196.731 551.279 196.731 551.303 196.732C551.351 196.734 551.413 196.737 551.492 196.741C551.652 196.75 551.852 196.763 552.1 196.78C552.589 196.813 553.233 196.857 553.974 196.898C555.459 196.978 557.376 197.045 559.452 196.979C563.44 196.851 568.645 196.227 572.395 193.726L569.067 188.734C566.817 190.234 563.105 190.859 559.26 190.982C557.42 191.04 555.69 190.982 554.3 190.906C553.084 190.84 551.744 190.73 551.231 190.73V196.73ZM567.673 160.318C569.018 153.59 568.975 142.739 566.34 132.309C563.717 121.923 558.344 111.27 548.436 105.866L545.563 111.134C553.333 115.372 558.075 124.084 560.523 133.778C562.96 143.427 562.943 153.371 561.789 159.142L567.673 160.318ZM572.395 193.726C576.088 191.264 578.371 188.048 579.399 184.453C580.413 180.908 580.151 177.201 579.135 173.752C577.128 166.936 572.008 160.53 566.252 157.144L563.21 162.316C567.661 164.934 571.806 170.102 573.38 175.447C574.154 178.078 574.261 180.598 573.63 182.804C573.014 184.96 571.638 187.02 569.067 188.734L572.395 193.726ZM421.742 151.382C422.283 152.914 423.356 154.049 424.723 154.656C426.027 155.234 427.416 155.256 428.615 154.979C430.94 154.441 433.345 152.556 433.872 149.557L427.963 148.517C427.944 148.624 427.891 148.739 427.764 148.861C427.625 148.994 427.437 149.093 427.262 149.133C427.08 149.175 427.055 149.126 427.156 149.171C427.213 149.196 427.281 149.241 427.339 149.304C427.398 149.368 427.409 149.409 427.4 149.384L421.742 151.382Z"
        fill="black"
      />
      <path
        d="M513.231 150.23C507.791 180.657 552.164 200.965 565.231 157.73"
        stroke="black"
        stroke-width="6"
        stroke-linecap="round"
      />
      <circle r="3" transform="matrix(1 0 0 -1 531 166)" fill="black" />
      <circle r="3" transform="matrix(1 0 0 -1 546 166)" fill="black" />
      <path
        d="M495.092 455.999C495.544 455.372 496.671 455.076 497.373 455.401L561.991 485.246C562.128 485.31 562.19 485.37 562.211 485.395C562.222 485.408 562.227 485.416 562.229 485.42C562.229 485.424 562.229 485.434 562.225 485.451C562.219 485.482 562.195 485.565 562.107 485.688L535.788 522.156C535.336 522.783 534.209 523.078 533.507 522.754L468.889 492.909C468.752 492.845 468.691 492.785 468.669 492.76C468.658 492.747 468.653 492.739 468.651 492.735C468.651 492.731 468.651 492.721 468.655 492.704C468.661 492.673 468.685 492.59 468.773 492.467L495.092 455.999ZM468.652 492.738C468.652 492.738 468.651 492.737 468.651 492.736L468.652 492.738Z"
        fill="#D9D9D9"
        stroke="black"
        stroke-width="6"
      />
      <path
        d="M463.934 493.353L451.022 455.792C449.881 452.472 453.266 449.397 456.462 450.851L524.214 481.687C525.341 482.2 526.166 483.205 526.451 484.409L534.648 519.151C535.408 522.37 532.153 525.068 529.13 523.725L466.092 495.708C465.077 495.256 464.295 494.403 463.934 493.353Z"
        fill="#D9D9D9"
        stroke="black"
        stroke-width="6"
      />
      <path
        d={path}
        fill="#8EE7ED"
        stroke="black"
        stroke-width="6"
      />
      <path
        d="M637.5 368C638.5 370.5 639 373.5 637.5 376.5"
        stroke="black"
        stroke-width="5"
        stroke-linecap="round"
      />
      <path
        d="M505 440.5C520.5 460.5 547.265 445.026 547 434"
        stroke="black"
        stroke-width="6"
        stroke-linecap="round"
      />
      <path
        d="M551 454.5C548 456.167 541.6 460.6 540 465"
        stroke="black"
        stroke-width="6"
        stroke-linecap="round"
      />
      <path
        d="M525 454C526.833 455.667 531.3 459.3 534.5 460.5"
        stroke="black"
        stroke-width="6"
        stroke-linecap="round"
      />
      <circle cx="527.5" cy="429.5" r="2.5" fill="black" />
      <circle cx="512.5" cy="424.5" r="2.5" fill="black" />
      <path
        d="M616.985 156C617.385 148.778 609.79 143 605.394 143C608.591 148.084 607.392 152.244 606.193 153.689C603.865 150.976 601.891 149.935 598.199 148.2C600.198 151.956 598.919 156 597 156"
        stroke="#B6D773"
        stroke-width="5"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <path
        d="M137 443.667C139.138 445.3 150.648 443.008 152.372 432C153.165 437.333 155.678 440.889 155.347 443.667C158.488 441.444 161.793 439.5 161.793 436.167C162.19 440.167 164.934 445.056 166.256 447C169.066 445.889 174.686 442.167 174.686 436.167C177.86 438.167 177.661 443.667 187.083 443.667C196.504 443.667 197 443.667 197 443.667"
        stroke="#B6D773"
        stroke-width="5"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
      <g transform="scale(1,0.8) rotate(30) translate(250,0)">
        <foreignObject width="420" height="320">
          <div
            ref={wrapperElement}
            style="
                  font-size: 1.3em;
                  word-break: break-all;
                  white-space: pre-wrap;
                  width: 100%;
                  height: 100%;
                  background: transparent;
                  color: white;
                  border: none;
                  outline: none;
                  overflow-y: hidden;
                  font-family: 'Courier New', Courier, monospace;
                  line-height: 1.2;
                "
          >
            <span id="output" dangerouslySetInnerHTML={{ __html: text }}></span>
            <span class="caret"></span>
          </div>
        </foreignObject>
      </g>
    </svg>
  );
}
